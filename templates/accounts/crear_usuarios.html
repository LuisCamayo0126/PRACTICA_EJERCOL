{% extends 'base.html' %}
{% load static %}

{% block title %}Crear Usuarios - Mi App{% endblock %}
{% block body_class %}register-page{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/crear_usuarios.css' %}?v=2024110501">
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/crear_usuarios.js' %}?v=2024110501"></script>
<script>
  // Inicializar URLs para el módulo crear_usuarios
  document.addEventListener('DOMContentLoaded', function() {
    if (window.CrearUsuariosModule) {
      // Flag de autenticación inyectado desde Django
  const requireAuthFlag = ('{{ require_auth|yesno:"true,false" }}' === 'true');
      CrearUsuariosModule.initializeUrls(
        '{{ csrf_token }}',
  '{% url "accounts:validate_admin" %}',
  '{% url "accounts:crear_usuarios" %}',
  '{% url "accounts:login" %}',
        requireAuthFlag
      );
    }
  });
</script>
{% endblock %}

{% block content %}
<!-- Botón Volver Atrás -->
{% url 'accounts:admin_home' as admin_home_url %}
{% include 'includes/back_button.html' with href=admin_home_url label='Volver Atrás' %}

<!-- Modal de Éxito -->
<div class="success-overlay" id="successOverlay">
  <div class="success-modal">
    <div class="success-icon">
      <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M20 6L9 17l-5-5" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    </div>
    
    <h2 class="success-title">¡Registro Exitoso!</h2>
    <p class="success-message">El usuario militar ha sido registrado correctamente en el sistema.</p>
    
    <div class="success-details">
      <h4>Datos del nuevo usuario:</h4>
      <p id="successUserInfo">Se han generado las credenciales automáticamente</p>
    </div>
    
    <div class="success-actions">
      <button type="button" class="btn-success-new" id="registerAnother">
        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M12 6V18M6 12H18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
        Registrar Otro
      </button>
      <button type="button" class="btn-success-close" id="closeSuccess">Cerrar</button>
    </div>
  </div>
</div>

{% if require_auth %}
<!-- Modal de Autenticación Administrativa -->
<div class="admin-auth-overlay" id="adminAuthOverlay">
  <div class="admin-auth-modal">
    <div class="modal-header">
      <div class="modal-icon">
        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M12 1L21.5 6.5V17.5L12 23L2.5 17.5V6.5L12 1Z" fill="currentColor"/>
          <path d="M12 8C13.1046 8 14 8.89543 14 10C14 11.1046 13.1046 12 12 12C10.8954 12 10 11.1046 10 10C10 8.89543 10.8954 8 12 8Z" fill="white"/>
          <path d="M9 16C9 15.4477 9.44772 15 10 15H14C14.5523 15 15 15.4477 15 16C15 16.5523 14.5523 17 14 17H10C9.44772 17 9 16.5523 9 16Z" fill="white"/>
        </svg>
      </div>
      <h2 class="modal-title">Acceso Administrativo Requerido</h2>
      {% if user_role == 'instructor_soldado' %}
        <p class="modal-subtitle">Como {{ user.username }}, necesitas autorización administrativa para crear usuarios</p>
      {% else %}
        <p class="modal-subtitle">Se requieren credenciales de administrador para acceder a "Crear Usuarios"</p>
      {% endif %}
    </div>
    
    <div class="modal-error" id="modalError" style="display: none;"></div>
    
    <form class="modal-form" id="adminAuthForm">
      <div class="modal-form-group">
        <label for="adminUser" class="modal-label">Usuario Administrador</label>
        <input type="text" id="adminUser" name="admin_user" class="modal-input" required>
      </div>
      
      <div class="modal-form-group">
        <label for="adminPass" class="modal-label">Contraseña</label>
        <input type="password" id="adminPass" name="admin_pass" class="modal-input" required>
      </div>
      
      <div class="modal-actions">
        <button type="button" class="btn-modal-cancel" id="cancelAuth">Cancelar</button>
        <button type="submit" class="btn-modal-auth">Autenticar</button>
      </div>
    </form>
  </div>
</div>
{% endif %}

<!-- Header de Navegación Específico -->
<div class="admin-navigation-header">
  <div class="nav-container">
    <div class="nav-left">
      <div class="nav-logo">
        <img src="{% static 'images/Escudo_Ejercito.png' %}" alt="Escudo del Ejército" class="nav-logo-img">
        <span class="nav-title">Evaluación de competencias</span>
      </div>
    </div>
    
    <div class="nav-center">
      <nav class="nav-menu">
        <a href="#" class="nav-item">TERCERA DIVISIÓN</a>
        {% if user.is_authenticated %}
          {% if user.is_staff or user.is_superuser or request.session.role_selected == 'admin' or request.session.role_selected == 'instructor' %}
            <a href="{% url 'accounts:crear_cursos' %}" class="nav-item">CREAR CURSOS</a>
            <a href="{% url 'accounts:crear_usuarios' %}" class="nav-item nav-item-active">CREAR USUARIOS</a>
          {% endif %}
        {% endif %}
        <a href="#" class="nav-item">GRUPOS USUARIOS</a>
        <a href="#" class="nav-item">FORMULARIOS</a>
      </nav>
    </div>
  </div>
  <div class="nav-line"></div>
</div>

<main class="register-wrapper">
  <div class="register-container">
    <div class="register-card">
      <div class="register-content" id="registerContent">
        <div class="register-header">
          <div class="register-icon">
            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M16 7C16 9.20914 14.2091 11 12 11C9.79086 11 8 9.20914 8 7C8 4.79086 9.79086 3 12 3C14.2091 3 16 4.79086 16 7Z" fill="currentColor"/>
              <path d="M12 14C8.13401 14 5 17.134 5 21H19C19 17.134 15.866 14 12 14Z" fill="currentColor"/>
            </svg>
          </div>
          <h1 class="register-title">Crear Usuarios</h1>
          <p class="register-subtitle">Complete la información del personal militar</p>
        </div>

      <form method="post" class="register-form" autocomplete="off">
        {% csrf_token %}
        
        <div class="form-section">
          <h3 class="section-title"></h3>
          
          <div class="excel-upload">
            <p class="excel-text">Por Favor subir el archivo excel para autocompletar los campos</p>
            <div class="excel-icon">
              <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M3 3h18v18H3z"/>
                <path d="M7 7h10v10H7z" fill="white"/>
                <text x="12" y="13" text-anchor="middle" fill="#107C41" font-family="Arial" font-size="6" font-weight="bold">X</text>
              </svg>
              <span>Excel</span>
            </div>
          </div>
          
          <!-- Fila 1 -->
          <div class="form-row-four">
            <div class="form-group-military">
              <label class="field-label">Grado</label>
              <input type="text" name="grado" class="form-input-military" placeholder="" autocomplete="off">
            </div>
            <div class="form-group-military">
              <label class="field-label">Arma</label>
              <input type="text" name="arma" class="form-input-military" placeholder="" autocomplete="off">
            </div>
            <div class="form-group-military">
              <label class="field-label">Apellidos</label>
              <input type="text" name="apellidos" class="form-input-military" placeholder="" autocomplete="off">
            </div>
            <div class="form-group-military">
              <label class="field-label">Nombres</label>
              <input type="text" name="nombres" class="form-input-military" placeholder="" autocomplete="off">
            </div>
          </div>
          
          <!-- Fila 2 -->
          <div class="form-row-four">
            <div class="form-group-military">
              <label class="field-label">Cédula</label>
              <input type="text" name="cedula" class="form-input-military" placeholder="" autocomplete="off">
            </div>
            <div class="form-group-military">
              <!-- Este campo mantiene el placeholder interno según requerimiento -->
              <label class="field-label visually-hidden">Lugar de expedición</label>
              <input type="text" name="lugar_expedicion" class="form-input-military" placeholder="Lugar de expedición" autocomplete="off">
            </div>
            <div class="form-group-military">
              <label class="field-label">Teléfono</label>
              <input type="text" name="telefono" class="form-input-military" placeholder="" autocomplete="off">
            </div>
            <div class="form-group-military">
              <label class="field-label">Fecha de nacimiento</label>
              <input type="date" name="fecha_nacimiento" class="form-input-military" placeholder="" autocomplete="off">
            </div>
          </div>
          
          <!-- Fila 3 -->
          <div class="form-row-four">
            <div class="form-group-military">
              <label class="field-label">Sexo</label>
              <input type="text" name="sexo" class="form-input-military" placeholder="" autocomplete="off">
            </div>
            <div class="form-group-military">
              <label class="field-label">RH</label>
              <input type="text" name="rh" class="form-input-military" placeholder="" autocomplete="off">
            </div>
            <div class="form-group-military">
              <label class="field-label">Tiempo de servicio</label>
              <input type="text" name="tiempo_servicio" class="form-input-military" placeholder="" autocomplete="off">
            </div>
            <div class="form-group-military">
              <label class="field-label">Aptitud física</label>
              <input type="text" name="aptitud_fisica" class="form-input-military" placeholder="" autocomplete="off">
            </div>
          </div>
          
          <!-- Fila 4 -->
          <div class="form-row-four">
            <div class="form-group-military">
              <label class="field-label">Brigada</label>
              <input type="text" name="brigada" class="form-input-military" placeholder="" autocomplete="off">
            </div>
            <div class="form-group-military">
              <label class="field-label">Batallón</label>
              <input type="text" name="batallon" class="form-input-military" placeholder="" autocomplete="off">
            </div>
            <div class="form-group-military">
              <label class="field-label">Compañía</label>
              <input type="text" name="compania" class="form-input-military" placeholder="" autocomplete="off">
            </div>
            <div class="form-group-military">
              <label class="field-label">Pelotón</label>
              <input type="text" name="peloton" class="form-input-military" placeholder="" autocomplete="off">
            </div>
          </div>

          <!-- Campos de autenticación (ocultos pero necesarios para Django) -->
          <div class="auth-fields" style="display: none;">
            <input type="text" name="username" id="hidden_username">
            <input type="email" name="email" id="hidden_email">
            <input type="text" name="first_name" id="hidden_first_name">
            <input type="text" name="last_name" id="hidden_last_name">
            <input type="password" name="password1" id="hidden_password1">
            <input type="password" name="password2" id="hidden_password2">
            <input type="text" name="admin_username" id="hidden_admin_username">
            <input type="password" name="admin_password" id="hidden_admin_password">
          </div>
        </div>

        <!-- Sección de Vista Previa de Excel -->
        <div class="excel-preview-section" id="excelPreviewSection">
          <div class="excel-preview-header">
            <h3 class="preview-title">El archivo ha sido cargado con éxito por favor verifique los datos</h3>
            <p class="preview-subtitle">Revise la información antes de confirmar el registro masivo</p>
          </div>
          
          <div class="excel-table-container">
            <table class="excel-preview-table" id="excelPreviewTable">
              <thead>
                <tr>
                  <th>GRADO</th>
                  <th>ARMA</th>
                  <th>APELLIDOS</th>
                  <th>NOMBRES</th>
                  <th>CÉDULA</th>
                  <th>LUGAR Y FECHA DE NACIMIENTO</th>
                  <th>TELÉFONO</th>
                  <th>FECHA DE NACIMIENTO</th>
                  <th>SEXO</th>
                  <th>RH</th>
                </tr>
              </thead>
              <tbody id="excelTableBody">
                <!-- Filas dinámicas -->
              </tbody>
            </table>
          </div>

          <div class="excel-preview-actions">
            <div class="excel-stats">
              <div class="stat-item">
                <span class="stat-number" id="totalRecords">0</span>
                <div class="stat-label">Registros Totales</div>
              </div>
              <div class="stat-item">
                <span class="stat-number" id="validRecords">0</span>
                <div class="stat-label">Registros Válidos</div>
              </div>
              <div class="stat-item">
                <span class="stat-number" id="invalidRecords">0</span>
                <div class="stat-label">Registros con Errores</div>
              </div>
            </div>
            
            <button type="button" class="btn-confirm-excel" id="confirmExcelData">
              Enviar Información
            </button>
            <button type="button" class="btn-cancel-excel" id="cancelExcelData">
              Cancelar
            </button>
          </div>
        </div>

        {% if form.non_field_errors %}
          <div class="form-errors">
            {% for error in form.non_field_errors %}
              <div class="error-message">{{ error }}</div>
            {% endfor %}
          </div>
        {% endif %}

        <div class="form-actions">
          <button type="submit" class="btn-enviar-info">
            Enviar Información
          </button>
        </div>

        <div class="form-links">
          {% if user.is_authenticated %}
            <a href="{% if user.is_staff %}{% url 'accounts:admin_home' %}{% elif user.groups.all.0.name == 'Instructor' %}{% url 'accounts:instructor_dashboard' %}{% else %}{% url 'accounts:soldado_home' %}{% endif %}" class="link-back">
              <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z" fill="currentColor"/>
              </svg>
              Volver al panel principal
            </a>
          {% else %}
            <a href="{% url 'accounts:login' %}" class="link-back">
              <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z" fill="currentColor"/>
              </svg>
              Volver al inicio de sesión
            </a>
          {% endif %}
        </div>
      </form>
      </div> <!-- Cierre del register-content -->
    </div>
  </div>
</main>

{% endblock %}